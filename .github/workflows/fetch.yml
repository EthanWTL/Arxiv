# .github/workflows/fetch.yml
name: Fetch Daily Arxiv Papers

on:
  schedule:
    - cron: "0 9 * * *"     # daily at 09:00 UTC
  workflow_dispatch:
    inputs:
      date:
        description: "UTC date (YYYY-MM-DD). Leave empty for today."
        required: false
        default: ""
      categories:
        description: "Space-separated categories (e.g., 'cs.AI cs.CV'). Leave empty for defaults."
        required: false
        default: ""
      dry_run:
        description: "If true, do not push commits; just upload artifacts."
        required: false
        default: "true"

permissions:
  contents: write  # needed for git push when not dry-run

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: pip install "requests==2.*"

      - name: Ensure output dir
        run: mkdir -p paper_json

      - name: Show chosen inputs
        run: |
          echo "date=${{ github.event.inputs.date }}"
          echo "categories=${{ github.event.inputs.categories }}"
          echo "dry_run=${{ github.event.inputs.dry_run }}"
          
      - name: Run fetch (manual or scheduled)
        shell: bash
        run: |
          set -euo pipefail

          DATE_ARG=""
          if [ -n "${{ github.event.inputs.date }}" ]; then
            DATE_ARG="--date ${{ github.event.inputs.date }}"
          fi

          CATS_ARG=""
          if [ -n "${{ github.event.inputs.categories }}" ]; then
            CATS_ARG="--categories ${{ github.event.inputs.categories }}"
          fi

          DRY_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_FLAG="--dry-run"
          fi

          echo "Running: python fetch_papers.py $DATE_ARG $CATS_ARG $DRY_FLAG"
          python fetch_papers.py $DATE_ARG $CATS_ARG $DRY_FLAG

      - name: Show results (debug)
        shell: bash
        run: |
          set -euo pipefail
          ls -la paper_json || true
          FILE="$(ls -1 paper_json/*.json 2>/dev/null | tail -n 1 || true)"
          if [ -n "$FILE" ]; then
            echo "Latest file: $FILE"
            python -c "import json,sys; f=sys.argv[1]; d=json.load(open(f)); print('Paper count:', len(d)); print('First:', {'id': (d[0].get('id') if d else None), 'title': (d[0].get('title') if d else None), 'published': (d[0].get('published') if d else None)})" "$FILE"
          else
            echo 'No JSON files found.'
          fi

      - name: Upload JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: paper-json
          path: paper_json/*.json
          if-no-files-found: warn

      - name: Commit & push (only when NOT dry-run)
        if: ${{ github.event.inputs.dry_run != 'true' || github.event_name == 'schedule' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -f paper_json/*.json || true
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Daily update: $(date -u +'%Y-%m-%d')"
          git push
